<!doctype html>
<html>
  <head>
    <title>Rate My Lambeth</title>
    <style>
      #street-view {
        height: 400px;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="street-view"></div>
    <div id="info-panel"></div>

    <fieldset>
      <legend>Is this street hot?</legend>

      <input type="radio" id="yes" name="hotornot" value="yes" />
      <label for="yes">Yes</label>

      <input type="radio" id="no" name="hotornot" value="no" />
      <label for="no">No</label>

      <input checked type="radio" id="dunno" name="hotornot" value="dunno" />
      <label for="dunno">I Dunno</label>
    </fieldset>

    <button id="new_street">New Street</button>
    <button id="submit">Submit</button>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_lLDblzEhAKvNL7ppvUnfQxRkFUL08Bk"
      async
      defer
    ></script>
    <script>
      let panorama;
      let streetPoints = [];

      fetch("/static/data.json")
        .then((r) => r.json())
        .then((data) => {
          streetPoints = data;
          initialize();
        });

      function getRandomLocation() {
        const lat =
          Math.random() * (lambethBounds.north - lambethBounds.south) +
          lambethBounds.south;
        const lng =
          Math.random() * (lambethBounds.east - lambethBounds.west) +
          lambethBounds.west;
        return { lat, lng };
      }

      function getRandomLocation2() {
        const loc =
          streetPoints[Math.floor(Math.random() * streetPoints.length)];
        updateInfoPanel(loc);
        return loc;
      }

      function initialize() {
        const fenway = getRandomLocation2();
        console.log(fenway);
        panorama = new google.maps.StreetViewPanorama(
          document.getElementById("street-view"),
          {
            position: fenway,
            pov: { heading: 165, pitch: 0 },
            zoom: 1,
            // addressControl: false,
            linksControl: false,
            motionTracking: false,
            motionTrackingControl: false,
            fullscreenControl: false,
            enableCloseButton: false,
            clickToGo: false,
          },
        );

        panorama.addListener("status_changed", function () {
          if (panorama.getStatus() !== google.maps.StreetViewStatus.OK) {
            setRandomLocation();
          }
        });
      }

      function setRandomLocation() {
        const loc = getRandomLocation2();
        panorama.setPosition(loc);
        console.log(loc);
      }

      function submitRating() {
        alert("thanks!");
        setRandomLocation();
      }

      function updateInfoPanel(location) {
        const infoPanel = document.getElementById("info-panel");
        infoPanel.innerHTML = `
                <h3>${location.name || "Unnamed Street"}</h3>
                <p>Type: ${location.highway}</p>
                <p>One-way: ${location.oneway ? "Yes" : "No"}</p>
                <p>Max Speed: ${location.maxspeed || "Not specified"}</p>
            `;
      }

      button = document.getElementById("new_street");
      button.addEventListener("click", setRandomLocation);

      submit = document.getElementById("submit");
      submit.addEventListener("click", submitRating);
    </script>
  </body>
</html>
